# ğŸ—ï¸ StackFood - Complete Architecture Documentation

**Event-Driven Microservices Platform on AWS EKS**

> DocumentaÃ§Ã£o tÃ©cnica completa seguindo C4 Model para arquitetura de software, infraestrutura AWS e padrÃµes de comunicaÃ§Ã£o event-driven.

---

## ğŸ“‹ Table of Contents

1. [C4 Model](#-c4-model-architecture-views)
   - [Level 1: System Context](#level-1-system-context-diagram)
   - [Level 2: Container Diagram](#level-2-container-diagram)
   - [Level 3: Component Diagram](#level-3-component-diagram)
   - [Level 4: Code Diagram](#level-4-code-diagram)
2. [Infrastructure Architecture](#-infrastructure-architecture)
3. [API Gateway Deep Dive](#-api-gateway-deep-dive)
4. [Event-Driven Messaging](#-event-driven-messaging)
5. [Microservices Details](#-microservices-details)
6. [Security & IAM](#-security--iam)
7. [Deployment & GitOps](#-deployment--gitops)
8. [Monitoring & Observability](#-monitoring--observability)
9. [Scalability & Performance](#-scalability--performance)
10. [Diagrams for Tools](#-diagrams-for-tools)

---

## ğŸ¯ C4 Model Architecture Views

### Level 1: System Context Diagram

**High-level view of StackFood ecosystem and external interactions**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EXTERNAL SYSTEMS                            â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Customer   â”‚  â”‚  Restaurant  â”‚  â”‚    Admin     â”‚               â”‚
â”‚  â”‚   (Mobile/   â”‚  â”‚   Staff      â”‚  â”‚              â”‚               â”‚
â”‚  â”‚     Web)     â”‚  â”‚   (Tablet)   â”‚  â”‚   (Portal)   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                  â”‚                  â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STACKFOOD SYSTEM                             â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      AWS Cloud Platform                         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  Cloudflare   â”‚â”€â”€â”€â”€â–¶â”‚       AWS API Gateway            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (CDN + DNS)  â”‚     â”‚   api.stackfood.com.br          â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                    â”‚                            â”‚  â”‚
â”‚  â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚                        â”‚                       â”‚                â”‚  â”‚
â”‚  â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚                â”‚    Lambda    â”‚       â”‚   VPC Link   â”‚        â”‚  â”‚
â”‚  â”‚                â”‚ (Auth/Create)â”‚       â”‚              â”‚        â”‚  â”‚
â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                        â”‚                      â”‚                â”‚  â”‚
â”‚  â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚                â”‚   Cognito    â”‚       â”‚  EKS Cluster â”‚        â”‚  â”‚
â”‚  â”‚                â”‚  User Pools  â”‚       â”‚  (K8s 1.34)  â”‚        â”‚  â”‚
â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                               â”‚                â”‚  â”‚
â”‚  â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚                          â”‚                    â”‚          â”‚     â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â–¼â”€â”€â” â”‚  â”‚
â”‚  â”‚            â”‚  Microservices   â”‚  â”‚  SNS/SQS        â”‚  â”‚RDS â”‚ â”‚  â”‚
â”‚  â”‚            â”‚  (5 services)    â”‚  â”‚  (Messaging)    â”‚  â”‚ +  â”‚ â”‚  â”‚
â”‚  â”‚            â”‚                  â”‚  â”‚                 â”‚  â”‚DDB â”‚ â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SUPPORTING SYSTEMS                             â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Mercado Pago â”‚  â”‚   ArgoCD     â”‚  â”‚  Grafana     â”‚               â”‚
â”‚  â”‚  (Payments)   â”‚  â”‚  (GitOps)    â”‚  â”‚(Monitoring)  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**External Actors:**
- **Customers**: Mobile/Web app users placing orders
- **Restaurant Staff**: Kitchen staff viewing production queue
- **Admin**: Back-office users managing products, orders, and customers

**External Systems:**
- **Mercado Pago**: Payment gateway integration (fake checkout in MVP)
- **ArgoCD**: GitOps continuous deployment
- **Grafana**: Metrics visualization and alerting
- **Cloudflare**: CDN, DNS, and DDoS protection

---

### Level 2: Container Diagram

**Containers (applications and data stores) that make up StackFood**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AWS CLOUD (us-east-1)                           â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           EDGE LAYER                                  â”‚   â”‚
â”‚  â”‚                                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Cloudflare CDN â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     AWS API Gateway (Regional)     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  DNS: stackfood â”‚         â”‚  api.stackfood.com.br              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚      .com.br    â”‚         â”‚  ID: pzfktuwsob                    â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  Stage: v1                         â”‚ â”‚   â”‚
â”‚  â”‚                               â”‚  Type: REST API                    â”‚ â”‚   â”‚
â”‚  â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                          â”‚                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚                                â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                              â”‚                               â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         SERVERLESS        â”‚                               â”‚  CONTAINER   â”‚â”‚
â”‚  â”‚                           â”‚                               â”‚  PLATFORM    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚   Lambda Functions            â”‚             â”‚    VPC Link        â”‚   â”‚â”‚
â”‚  â”‚  â”‚   Runtime: .NET 8             â”‚             â”‚    ID: m0v6wp      â”‚   â”‚â”‚
â”‚  â”‚  â”‚                               â”‚             â”‚  Status: AVAILABLE â”‚   â”‚â”‚
â”‚  â”‚  â”‚   stackfood-auth:             â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚  â”‚   - POST /auth                â”‚                       â”‚              â”‚â”‚
â”‚  â”‚  â”‚   - POST /customer            â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚                               â”‚             â”‚  Network Load      â”‚   â”‚â”‚
â”‚  â”‚  â”‚   Memory: 256MB               â”‚             â”‚  Balancer (NLB)    â”‚   â”‚â”‚
â”‚  â”‚  â”‚   Timeout: 30s                â”‚             â”‚  Scheme: internet- â”‚   â”‚â”‚
â”‚  â”‚  â”‚   VPC: Enabled                â”‚             â”‚  facing            â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  Type: network     â”‚   â”‚â”‚
â”‚  â”‚               â”‚                                â”‚  Subnets: 3 public â”‚   â”‚â”‚
â”‚  â”‚               â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚               â”‚                                          â”‚              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚   AWS Cognito User Pools      â”‚             â”‚  NGINX Ingress    â”‚   â”‚â”‚
â”‚  â”‚  â”‚                               â”‚             â”‚  Controller       â”‚   â”‚â”‚
â”‚  â”‚  â”‚   1. stackfood-app-pool       â”‚             â”‚  Replicas: 2      â”‚   â”‚â”‚
â”‚  â”‚  â”‚      (Customers + Staff)      â”‚             â”‚  Version: 4.10.0  â”‚   â”‚â”‚
â”‚  â”‚  â”‚   2. stackfood-argocd-pool    â”‚             â”‚  Class: nginx     â”‚   â”‚â”‚
â”‚  â”‚  â”‚      (GitOps access)          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚  â”‚                               â”‚                       â”‚              â”‚â”‚
â”‚  â”‚  â”‚   Auth: CPF-based (custom)    â”‚                       â”‚              â”‚â”‚
â”‚  â”‚  â”‚   MFA: Disabled               â”‚                       â”‚              â”‚â”‚
â”‚  â”‚  â”‚   Token TTL: 60min            â”‚                       â”‚              â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚              â”‚â”‚
â”‚  â”‚                                                           â”‚              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                               â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  EKS CLUSTER (stackfood-eks)              â”‚              â”‚â”‚
â”‚  â”‚                  Kubernetes: 1.34                         â”‚              â”‚â”‚
â”‚  â”‚                  Nodes: 2x t3.large                       â”‚              â”‚â”‚
â”‚  â”‚                                                           â”‚              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚                      MICROSERVICES LAYER                           â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Customers   â”‚  â”‚   Products   â”‚  â”‚    Orders    â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Namespace:  â”‚  â”‚  Namespace:  â”‚  â”‚  Namespace:  â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  customers   â”‚  â”‚  products    â”‚  â”‚   orders     â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Port: 8084  â”‚  â”‚  Port: 8080  â”‚  â”‚  Port: 8081  â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Replicas: 2 â”‚  â”‚  Replicas: 2 â”‚  â”‚  Replicas: 2 â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  DB: RDS PG  â”‚  â”‚  DB: RDS PG  â”‚  â”‚  DB: RDS PG  â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚  + Cognito   â”‚  â”‚              â”‚  â”‚              â”‚            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚â”‚
â”‚  â”‚  â”‚         â”‚                  â”‚                  â”‚                    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   Payments      â”‚  â”‚  Production  â”‚  â”‚   ArgoCD     â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   Namespace:    â”‚  â”‚  Namespace:  â”‚  â”‚  Namespace:  â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   payments      â”‚  â”‚  production  â”‚  â”‚   argocd     â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚  â”‚              â”‚  â”‚              â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   Port: 8082    â”‚  â”‚  Port: 8083  â”‚  â”‚  Port: 443   â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   Replicas: 2   â”‚  â”‚  Replicas: 2 â”‚  â”‚  Replicas: 1 â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚   DB: DynamoDB  â”‚  â”‚  DB: RDS PG  â”‚  â”‚  Auth:       â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚  â”‚  (JSONB)     â”‚  â”‚  Cognito     â”‚        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚                    SUPPORTING SERVICES                           â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Prometheus    â”‚  â”‚    Grafana     â”‚  â”‚  Node Exporter â”‚    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚  (Metrics)     â”‚  â”‚  (Dashboard)   â”‚  â”‚  (Monitoring)  â”‚    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚  Namespace:    â”‚  â”‚  Namespace:    â”‚  â”‚  Namespace:    â”‚    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚  monitoring    â”‚  â”‚  monitoring    â”‚  â”‚  prometheus-   â”‚    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚  node-exporter â”‚    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        DATA STORES                                     â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  RDS PostgreSQLâ”‚  â”‚   DynamoDB     â”‚  â”‚   SNS Topics + SQS      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Version: 16.10â”‚  â”‚                â”‚  â”‚   Queues                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Instance:     â”‚  â”‚  Tables:       â”‚  â”‚                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  db.t3.micro   â”‚  â”‚  - payments    â”‚  â”‚  Topics:                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Multi-AZ: No  â”‚  â”‚  - orders      â”‚  â”‚  - order-events         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Public: Yes   â”‚  â”‚  - products    â”‚  â”‚  - payment-events       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Storage: 20GB â”‚  â”‚                â”‚  â”‚  - production-events    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                â”‚  â”‚  Billing:      â”‚  â”‚  - customer-events      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Databases:    â”‚  â”‚  Pay-per-req   â”‚  â”‚                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - stackfood   â”‚  â”‚  Encryption:   â”‚  â”‚  Queues: 8 main + 8 DLQ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    (shared)    â”‚  â”‚  Enabled       â”‚  â”‚  Retention: 14 days     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚  Long polling: 10s      â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Container Descriptions:**

1. **Cloudflare CDN**: Edge caching, DDoS protection, DNS management
2. **API Gateway**: HTTP routing, authentication delegation, rate limiting
3. **Lambda Functions**: Serverless auth and customer creation
4. **VPC Link**: Private connectivity between API Gateway and VPC
5. **NLB**: Layer 4 load balancing for NGINX Ingress
6. **NGINX Ingress**: Layer 7 routing within Kubernetes
7. **Microservices**: Business logic containers (.NET 8)
8. **Cognito**: Identity provider and user management
9. **RDS PostgreSQL**: Relational data storage
10. **DynamoDB**: NoSQL for payments and flexible schemas
11. **SNS/SQS**: Asynchronous event-driven messaging
12. **ArgoCD**: GitOps deployment automation
13. **Prometheus/Grafana**: Metrics collection and visualization

---

### Level 3: Component Diagram

**Components inside Customers Microservice (example)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Customers Microservice (Port 8084)                    â”‚
â”‚              Namespace: customers                                   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      API Layer                                â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚          CustomersController                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  GET    /api/customers                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  GET    /api/customers/{id}                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  POST   /api/customers                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  PUT    /api/customers/{id}                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  DELETE /api/customers/{id}                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  POST   /api/customers/auth                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                           â”‚                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Application Layer                            â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚           Customer Use Cases                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  CreateCustomerUseCase                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Validate CPF                                         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Create in PostgreSQL                                 â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Create in Cognito                                    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Publish CustomerCreated event                        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  AuthenticateCustomerUseCase                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Validate CPF                                         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Call Cognito InitiateAuth                            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Return JWT tokens                                    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  GetCustomerUseCase                                     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  UpdateCustomerUseCase                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  DeleteCustomerUseCase                                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                           â”‚                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Domain Layer                                â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚              Customer Entity                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Properties:                                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Id (Guid)                                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Name (string)                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Email (Email value object)                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - CPF (CPF value object)                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - CognitoId (string, nullable)                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - CreatedAt (DateTime)                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - UpdatedAt (DateTime)                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Methods:                                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Validate()                                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - UpdateEmail(Email)                                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - LinkCognito(string)                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚              Value Objects                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  CPF - Validates Brazilian CPF format and checksum       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Email - Validates email format                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚              Domain Events                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  CustomerCreated                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  CustomerUpdated                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  CustomerDeleted                                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 Infrastructure Layer                            â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚CustomerRepositoryâ”‚  â”‚ CognitoService   â”‚  â”‚ EventPublisherâ”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚ â”‚â”‚
â”‚  â”‚  â”‚  ICustomer       â”‚  â”‚  ICognito        â”‚  â”‚  IEvent      â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Repository      â”‚  â”‚  Service         â”‚  â”‚  Publisher   â”‚ â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚ â”‚â”‚
â”‚  â”‚  â”‚  PostgreSQL      â”‚  â”‚  AWS SDK         â”‚  â”‚  SNS Client  â”‚ â”‚â”‚
â”‚  â”‚  â”‚  EF Core         â”‚  â”‚  Cognito API     â”‚  â”‚  Topic: ...  â”‚ â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  Cross-Cutting Concerns                         â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚
â”‚  â”‚  â”‚  Logging â”‚  â”‚  Health  â”‚  â”‚ Metrics  â”‚  â”‚  Tracing â”‚       â”‚â”‚
â”‚  â”‚  â”‚ (Serilog)â”‚  â”‚  Checks  â”‚  â”‚(Prometheusâ”‚  â”‚ (OpenTel)â”‚       â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Component Responsibilities:**

- **Controllers**: HTTP request handling, validation, response formatting
- **Use Cases**: Business logic orchestration, transaction boundaries
- **Entities**: Core business objects with invariants
- **Value Objects**: Immutable domain concepts
- **Repositories**: Data persistence abstraction
- **External Services**: Third-party integrations (Cognito, SNS)
- **Events**: Domain event publishing for async communication

---

### Level 4: Code Diagram

**Class structure for Customer Entity (simplified)**

```csharp
// Domain/Entities/Customer.cs
public class Customer : Entity
{
    public Guid Id { get; private set; }
    public string Name { get; private set; }
    public Email Email { get; private set; }
    public CPF CPF { get; private set; }
    public string? CognitoId { get; private set; }
    public DateTime CreatedAt { get; private set; }
    public DateTime UpdatedAt { get; private set; }

    private Customer() { } // EF Core

    public Customer(string name, Email email, CPF cpf)
    {
        Id = Guid.NewGuid();
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Email = email ?? throw new ArgumentNullException(nameof(email));
        CPF = cpf ?? throw new ArgumentNullException(nameof(cpf));
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;

        Validate();
    }

    public void UpdateEmail(Email newEmail)
    {
        Email = newEmail ?? throw new ArgumentNullException(nameof(newEmail));
        UpdatedAt = DateTime.UtcNow;
    }

    public void LinkCognito(string cognitoId)
    {
        if (string.IsNullOrWhiteSpace(cognitoId))
            throw new ArgumentException("Cognito ID cannot be empty");

        CognitoId = cognitoId;
        UpdatedAt = DateTime.UtcNow;
    }

    private void Validate()
    {
        if (string.IsNullOrWhiteSpace(Name))
            throw new DomainException("Customer name is required");

        if (Name.Length < 3)
            throw new DomainException("Customer name must be at least 3 characters");
    }
}

// Domain/ValueObjects/CPF.cs
public sealed class CPF : ValueObject
{
    public string Value { get; }

    private CPF(string value)
    {
        Value = value;
    }

    public static CPF Create(string cpf)
    {
        if (string.IsNullOrWhiteSpace(cpf))
            throw new DomainException("CPF cannot be empty");

        var cleaned = new string(cpf.Where(char.IsDigit).ToArray());

        if (cleaned.Length != 11)
            throw new DomainException("CPF must have 11 digits");

        if (!ValidateChecksum(cleaned))
            throw new DomainException("Invalid CPF checksum");

        return new CPF(cleaned);
    }

    private static bool ValidateChecksum(string cpf)
    {
        // CPF validation algorithm
        // ...
        return true;
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return Value;
    }
}
```

---

## ğŸ—ï¸ Infrastructure Architecture

### AWS VPC Network Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  VPC: stackfood-vpc (10.0.0.0/16)                   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Availability Zone A                        â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚  â”‚  Public Subnet       â”‚    â”‚  Private Subnet      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  10.0.101.0/24       â”‚    â”‚  10.0.1.0/24         â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NLB               â”‚    â”‚  - EKS Node 1        â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NAT Gateway       â”‚    â”‚  - Pods              â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Availability Zone B                        â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚  â”‚  Public Subnet       â”‚    â”‚  Private Subnet      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  10.0.102.0/24       â”‚    â”‚  10.0.2.0/24         â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NLB               â”‚    â”‚  - EKS Node 2        â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NAT Gateway       â”‚    â”‚  - Pods              â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Availability Zone C                        â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚  â”‚  Public Subnet       â”‚    â”‚  Private Subnet      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  10.0.103.0/24       â”‚    â”‚  10.0.3.0/24         â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NLB               â”‚    â”‚  (Reserved)          â”‚         â”‚â”‚
â”‚  â”‚  â”‚  - NAT Gateway       â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â”‚                      â”‚    â”‚                      â”‚         â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  Internet Gateway    â”‚                                           â”‚
â”‚  â”‚  stackfood-vpc-igw   â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Kubernetes Cluster Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EKS Cluster: stackfood-eks                       â”‚
â”‚                    Version: 1.34                                     â”‚
â”‚                    Endpoint: Public + Private                       â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Control Plane (AWS Managed)                        â”‚â”‚
â”‚  â”‚              Multi-AZ, Auto-scaled by AWS                       â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  - API Server                                                   â”‚â”‚
â”‚  â”‚  - etcd                                                          â”‚â”‚
â”‚  â”‚  - Controller Manager                                           â”‚â”‚
â”‚  â”‚  - Scheduler                                                     â”‚â”‚
â”‚  â”‚  - CloudWatch Logs enabled                                      â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Data Plane (Node Groups)                   â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  Node Group: api                                           â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Instance Type: t3.large (2 vCPU, 8GB RAM)                â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Desired: 1, Min: 1, Max: 3                                â”‚ â”‚â”‚
â”‚  â”‚  â”‚  AMI: EKS Optimized                                        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Labels: role=api                                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Node 1 (ip-10-0-101-177.ec2.internal)                     â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - NGINX Ingress Pod 1                                     â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Customers Pod 1                                         â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Orders Pod 1                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Payments Pod 1                                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  Node Group: worker                                        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Instance Type: t3.large (2 vCPU, 8GB RAM)                â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Desired: 1, Min: 1, Max: 3                                â”‚ â”‚â”‚
â”‚  â”‚  â”‚  AMI: EKS Optimized                                        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Labels: role=worker                                       â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Node 2 (ip-10-0-102-132.ec2.internal)                     â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - NGINX Ingress Pod 2                                     â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Customers Pod 2                                         â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Orders Pod 2                                            â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Products Pod 2                                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Payments Pod 2                                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Production Pod 2                                        â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - ArgoCD Pod                                              â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Prometheus Pod                                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Add-ons                                     â”‚â”‚
â”‚  â”‚                                                                   â”‚â”‚
â”‚  â”‚  - VPC-CNI (v1.18)          - Pod networking                    â”‚â”‚
â”‚  â”‚  - CoreDNS (v1.11)          - Service discovery                 â”‚â”‚
â”‚  â”‚  - kube-proxy (v1.34)       - Service routing                   â”‚â”‚
â”‚  â”‚  - EBS CSI Driver           - Persistent volumes                â”‚â”‚
â”‚  â”‚                                                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸšª API Gateway Deep Dive

### Complete Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  REQUEST FLOW: API Gateway â†’ EKS                     â”‚
â”‚                                                                        â”‚
â”‚  1. Client Request                                                    â”‚
â”‚     GET https://api.stackfood.com.br/v1/orders/api/orders            â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  2. Cloudflare (CDN + DNS)                                           â”‚
â”‚     - DNS resolution: api.stackfood.com.br â†’ API Gateway             â”‚
â”‚     - CDN cache check (MISS for dynamic content)                     â”‚
â”‚     - DDoS protection                                                 â”‚
â”‚     - Forward to API Gateway                                          â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  3. AWS API Gateway (pzfktuwsob)                                     â”‚
â”‚     Stage: v1                                                         â”‚
â”‚     Resource: /orders/{proxy+}                                       â”‚
â”‚     Method: GET                                                       â”‚
â”‚                                                                        â”‚
â”‚     a) Method Request                                                 â”‚
â”‚        - Authorization: NONE (public)                                â”‚
â”‚        - Request Parameters:                                          â”‚
â”‚          method.request.path.proxy = true                            â”‚
â”‚        - Extracted: proxy = "api/orders"                             â”‚
â”‚                                                                        â”‚
â”‚     b) Integration Request                                            â”‚
â”‚        - Type: HTTP_PROXY                                            â”‚
â”‚        - Integration HTTP Method: GET                                â”‚
â”‚        - Connection: VPC_LINK (m0v6wp)                               â”‚
â”‚        - URI: http://NLB_DNS/orders/{proxy}                          â”‚
â”‚        - Request Parameters:                                          â”‚
â”‚          integration.request.path.proxy = method.request.path.proxy  â”‚
â”‚        - Final URI: http://NLB_DNS/orders/api/orders                â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  4. VPC Link (m0v6wp)                                                â”‚
â”‚     Status: AVAILABLE                                                 â”‚
â”‚     Target: NLB ARN                                                   â”‚
â”‚     - Establish private connection to VPC                            â”‚
â”‚     - Forward request to NLB                                          â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  5. Network Load Balancer                                             â”‚
â”‚     DNS: a15b3257851d441cab158f71eb788597-...elb.us-east-1.aws...   â”‚
â”‚     Type: network (Layer 4)                                          â”‚
â”‚     Scheme: internet-facing                                           â”‚
â”‚     Subnets: 3 public (multi-AZ)                                     â”‚
â”‚                                                                        â”‚
â”‚     - Receive: http://NLB_DNS/orders/api/orders                      â”‚
â”‚     - Listener: Port 80 â†’ Target Group (NGINX Ingress)              â”‚
â”‚     - Health Check: HTTP:80/ (NGINX default backend)                â”‚
â”‚     - Load balance to: 10.0.101.177:31670 or 10.0.102.132:31670     â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  6. NGINX Ingress Controller Pod                                      â”‚
â”‚     Namespace: ingress-nginx                                          â”‚
â”‚     Pod IP: 10.0.101.177 (example)                                   â”‚
â”‚     NodePort: 31670 (mapped to container port 80)                    â”‚
â”‚                                                                        â”‚
â”‚     - Receive: GET /orders/api/orders HTTP/1.1                       â”‚
â”‚     - Match Ingress Rule:                                             â”‚
â”‚       Path: /orders(/|$)(.*)                                         â”‚
â”‚       Regex: true                                                     â”‚
â”‚       Backend: stackfood-orders.orders.svc.cluster.local:8081       â”‚
â”‚     - Rewrite: /$2                                                    â”‚
â”‚       /orders/api/orders â†’ /api/orders                               â”‚
â”‚     - Forward to Service                                              â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  7. Kubernetes Service (stackfood-orders)                            â”‚
â”‚     Namespace: orders                                                 â”‚
â”‚     Type: ClusterIP                                                   â”‚
â”‚     Cluster IP: 172.20.50.82                                         â”‚
â”‚     Port: 8081                                                        â”‚
â”‚     Selector: app=stackfood-orders                                   â”‚
â”‚                                                                        â”‚
â”‚     - Load balance to Pod IPs:                                        â”‚
â”‚       10.0.102.139:8081 or 10.0.102.237:8081                        â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  8. Orders Pod                                                         â”‚
â”‚     Namespace: orders                                                 â”‚
â”‚     Pod IP: 10.0.102.139 (example)                                   â”‚
â”‚     Container Port: 8081                                              â”‚
â”‚     Image: stackfood-orders:latest                                    â”‚
â”‚                                                                        â”‚
â”‚     - Receive: GET /api/orders HTTP/1.1                              â”‚
â”‚     - Execute: OrdersController.GetOrders()                          â”‚
â”‚     - Query: PostgreSQL RDS                                           â”‚
â”‚     - Return: List<Order> as JSON                                    â”‚
â”‚                                                                        â”‚
â”‚                           â†“                                           â”‚
â”‚                                                                        â”‚
â”‚  9. Response Path (reverse flow)                                      â”‚
â”‚     Pod â†’ Service â†’ NGINX â†’ NLB â†’ VPC Link â†’ API GW â†’ CF â†’ Client   â”‚
â”‚                                                                        â”‚
â”‚     Final Response:                                                   â”‚
â”‚     HTTP/1.1 200 OK                                                  â”‚
â”‚     Content-Type: application/json                                    â”‚
â”‚                                                                        â”‚
â”‚     [                                                                 â”‚
â”‚       {                                                                â”‚
â”‚         "orderId": "uuid",                                            â”‚
â”‚         "customerId": "uuid",                                         â”‚
â”‚         "status": "Pending",                                          â”‚
â”‚         "items": [...]                                                 â”‚
â”‚       }                                                                â”‚
â”‚     ]                                                                 â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Gateway Route Matrix

| Route | Method | Type | Target | Auth |
|-------|--------|------|--------|------|
| `/auth` | POST | AWS_PROXY | Lambda: stackfood-auth | None |
| `/customer` | POST | AWS_PROXY | Lambda: stackfood-auth | None |
| `/customers/{proxy+}` | GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS | HTTP_PROXY | VPC Link â†’ NLB â†’ stackfood-customers:8084 | None |
| `/products/{proxy+}` | GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS | HTTP_PROXY | VPC Link â†’ NLB â†’ stackfood-products:8080 | None |
| `/orders/{proxy+}` | GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS | HTTP_PROXY | VPC Link â†’ NLB â†’ stackfood-orders:8081 | None |
| `/payments/{proxy+}` | GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS | HTTP_PROXY | VPC Link â†’ NLB â†’ stackfood-payments:8082 | None |
| `/production/{proxy+}` | GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS | HTTP_PROXY | VPC Link â†’ NLB â†’ stackfood-production:8083 | None |

**Total Routes:** 2 Lambda + 35 HTTP_PROXY (5 microservices Ã— 7 methods)

### NGINX Ingress Configuration

```yaml
# Example: Orders Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: stackfood-orders-ingress
  namespace: orders
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /orders(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: stackfood-orders
                port:
                  number: 8081
```

**Path Rewrite Explanation:**
- Request: `/orders/api/orders`
- Regex match: `/orders(/|$)(.*)`
  - Group 1: `/` or end of string
  - Group 2: `api/orders`
- Rewrite target: `/$2` â†’ `/api/orders`
- Final backend request: `GET /api/orders HTTP/1.1`

---

## ğŸ“¬ Event-Driven Messaging

### Complete Event Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EVENT-DRIVEN ARCHITECTURE                      â”‚
â”‚                                                                      â”‚
â”‚  1. Order Creation Flow                                             â”‚
â”‚                                                                      â”‚
â”‚     Client                                                          â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”‚ POST /orders/api/orders                                     â”‚
â”‚       â–¼                                                              â”‚
â”‚     Orders API                                                       â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”‚ 1. Save to PostgreSQL                                       â”‚
â”‚       â”‚ 2. Publish OrderCreated event                               â”‚
â”‚       â”‚                                                              â”‚
â”‚       â–¼                                                              â”‚
â”‚     SNS Topic: stackfood-order-events                               â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚                     â”‚                            â”‚          â”‚
â”‚       â–¼                     â–¼                            â–¼          â”‚
â”‚     Filter:               Filter:                     (Future)      â”‚
â”‚     OrderCreated          OrderCreated                              â”‚
â”‚     OrderCancelled        OrderConfirmed                            â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â–¼                     â–¼                                        â”‚
â”‚     SQS: stackfood-       SQS: stackfood-                           â”‚
â”‚     payment-events-       production-events-                        â”‚
â”‚     queue                 queue                                      â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â–¼                     â–¼                                        â”‚
â”‚     Payments API          Production API                            â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚  2. Payment Processing     â”‚  3. Production Processing              â”‚
â”‚                             â”‚                                        â”‚
â”‚     Payments API            â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚ Process payment     â”‚                                        â”‚
â”‚       â”‚ (Fake checkout)     â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚ Publish:            â”‚                                        â”‚
â”‚       â”‚ PaymentApproved     â”‚                                        â”‚
â”‚       â–¼                     â”‚                                        â”‚
â”‚     SNS Topic:              â”‚                                        â”‚
â”‚     stackfood-payment-      â”‚                                        â”‚
â”‚     events                  â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚ Filter:             â”‚                                        â”‚
â”‚       â”‚ PaymentApproved     â”‚                                        â”‚
â”‚       â”‚ PaymentFailed       â”‚                                        â”‚
â”‚       â”‚ PaymentRefunded     â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â–¼                     â”‚                                        â”‚
â”‚     SQS: stackfood-         â”‚                                        â”‚
â”‚     order-payment-          â”‚                                        â”‚
â”‚     events-queue            â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â–¼                     â”‚                                        â”‚
â”‚     Orders API              â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚ Update status:      â”‚                                        â”‚
â”‚       â”‚ PaymentApproved     â”‚                                        â”‚
â”‚       â”‚                     â”‚                                        â”‚
â”‚       â”‚                     â”‚  Production API                        â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â”‚ Start production                  â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â”‚ Publish:                          â”‚
â”‚       â”‚                     â”‚    â”‚ ProductionStarted                 â”‚
â”‚       â”‚                     â”‚    â–¼                                   â”‚
â”‚       â”‚                     â”‚  SNS Topic:                            â”‚
â”‚       â”‚                     â”‚  stackfood-production-                 â”‚
â”‚       â”‚                     â”‚  events                                â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â”‚ Filter:                           â”‚
â”‚       â”‚                     â”‚    â”‚ ProductionStarted                 â”‚
â”‚       â”‚                     â”‚    â”‚ ProductionCompleted               â”‚
â”‚       â”‚                     â”‚    â”‚ ProductionFailed                  â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â–¼                                   â”‚
â”‚       â”‚                     â”‚  SQS: stackfood-                       â”‚
â”‚       â”‚                     â”‚  order-production-                     â”‚
â”‚       â”‚                     â”‚  events-queue                          â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â–¼                                   â”‚
â”‚       â”‚                     â”‚  Orders API                            â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â”‚                     â”‚    â”‚ Update status:                    â”‚
â”‚       â”‚                     â”‚    â”‚ InProduction â†’ Ready              â”‚
â”‚       â”‚                     â”‚    â”‚                                   â”‚
â”‚       â–¼                     â–¼    â–¼                                   â”‚
â”‚                                                                       â”‚
â”‚     All updates persisted in PostgreSQL                             â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Message Structures

#### OrderCreated Event
```json
{
  "MessageId": "uuid",
  "TopicArn": "arn:aws:sns:us-east-1:975050205506:stackfood-order-events",
  "Message": {
    "eventType": "OrderCreated",
    "eventId": "uuid",
    "timestamp": "2025-12-30T01:00:00Z",
    "aggregateId": "9d90b301-535e-4ced-8dd2-19ea44652edf",
    "payload": {
      "orderId": "9d90b301-535e-4ced-8dd2-19ea44652edf",
      "customerId": "123e4567-e89b-12d3-a456-426614174000",
      "items": [
        {
          "productId": "prod-001",
          "productName": "Big Mac",
          "quantity": 2,
          "unitPrice": 15.99,
          "totalPrice": 31.98
        }
      ],
      "subtotal": 31.98,
      "tax": 3.20,
      "total": 35.18,
      "status": "Pending",
      "createdAt": "2025-12-30T01:00:00Z"
    }
  },
  "MessageAttributes": {
    "eventType": {
      "Type": "String",
      "Value": "OrderCreated"
    },
    "aggregateType": {
      "Type": "String",
      "Value": "Order"
    }
  }
}
```

#### PaymentApproved Event
```json
{
  "eventType": "PaymentApproved",
  "eventId": "uuid",
  "timestamp": "2025-12-30T01:01:00Z",
  "aggregateId": "9d90b301-535e-4ced-8dd2-19ea44652edf",
  "payload": {
    "orderId": "9d90b301-535e-4ced-8dd2-19ea44652edf",
    "paymentId": "pay-789",
    "amount": 35.18,
    "paymentMethod": "fake_checkout",
    "transactionId": "txn-123456",
    "approvedAt": "2025-12-30T01:01:00Z",
    "metadata": {
      "customerName": "PAGO",  // Fake checkout indicator
      "provider": "mercadopago_mock"
    }
  }
}
```

### SNS/SQS Configuration Details

**SNS Topic Settings:**
```hcl
resource "aws_sns_topic" "order_events" {
  name                        = "stackfood-order-events"
  display_name                = "StackFood Order Events"
  fifo_topic                  = false
  content_based_deduplication = false

  tags = {
    Service     = "orders"
    MessageType = "events"
  }
}
```

**SQS Queue Settings:**
```hcl
resource "aws_sqs_queue" "payment_events" {
  name                      = "stackfood-payment-events-queue"
  delay_seconds             = 0
  max_message_size          = 262144  # 256 KB
  message_retention_seconds = 1209600 # 14 days
  receive_wait_time_seconds = 10      # Long polling
  visibility_timeout_seconds = 300    # 5 minutes

  # Dead Letter Queue
  redrive_policy = jsonencode({
    deadLetterTargetArn = aws_sqs_queue.payment_events_dlq.arn
    maxReceiveCount     = 3
  })

  # Encryption
  sqs_managed_sse_enabled = true

  tags = {
    Service     = "payments"
    SourceTopic = "stackfood-order-events"
  }
}
```

**SNS Subscription with Filter Policy:**
```hcl
resource "aws_sns_topic_subscription" "order_to_payments" {
  topic_arn = aws_sns_topic.order_events.arn
  protocol  = "sqs"
  endpoint  = aws_sqs_queue.payment_events.arn

  # Only receive OrderCreated and OrderCancelled events
  filter_policy = jsonencode({
    eventType = ["OrderCreated", "OrderCancelled"]
  })

  raw_message_delivery = false
}
```

---

## ğŸ” Security & IAM

### IAM Roles and Policies

**EKS Service Account for Microservices:**

```yaml
# ServiceAccount with IRSA (IAM Roles for Service Accounts)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: stackfood-orders-sa
  namespace: orders
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::975050205506:role/LabRole
```

**IAM Policy for Orders Service:**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "SNSPublish",
      "Effect": "Allow",
      "Action": [
        "sns:Publish"
      ],
      "Resource": [
        "arn:aws:sns:us-east-1:975050205506:stackfood-order-events",
        "arn:aws:sns:us-east-1:975050205506:stackfood-customer-events"
      ]
    },
    {
      "Sid": "SQSConsume",
      "Effect": "Allow",
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes",
        "sqs:ChangeMessageVisibility"
      ],
      "Resource": [
        "arn:aws:sqs:us-east-1:975050205506:stackfood-order-payment-events-queue",
        "arn:aws:sqs:us-east-1:975050205506:stackfood-order-production-events-queue"
      ]
    },
    {
      "Sid": "RDSConnect",
      "Effect": "Allow",
      "Action": [
        "rds-db:connect"
      ],
      "Resource": [
        "arn:aws:rds-db:us-east-1:975050205506:dbuser:*/stackfood"
      ]
    }
  ]
}
```

### Network Security

**Security Groups:**

```hcl
# EKS Node Security Group
resource "aws_security_group" "eks_nodes" {
  name        = "stackfood-eks-nodes-sg"
  description = "Security group for EKS worker nodes"
  vpc_id      = var.vpc_id

  # Inbound from NLB
  ingress {
    from_port   = 30000
    to_port     = 32767
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/16"]  # VPC CIDR
    description = "NodePort range for NLB"
  }

  # Inbound from Control Plane
  ingress {
    from_port       = 443
    to_port         = 443
    protocol        = "tcp"
    security_groups = [aws_security_group.eks_cluster.id]
    description     = "Kubernetes API from control plane"
  }

  # Outbound to internet (for pulling images, AWS APIs)
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# RDS Security Group
resource "aws_security_group" "rds" {
  name        = "stackfood-rds-sg"
  description = "Security group for RDS PostgreSQL"
  vpc_id      = var.vpc_id

  # Inbound from EKS nodes
  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.eks_nodes.id]
    description     = "PostgreSQL from EKS"
  }

  # Inbound from Lambda (if in VPC)
  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.lambda.id]
    description     = "PostgreSQL from Lambda"
  }
}
```

### Secrets Management

**AWS Secrets Manager:**

```bash
# Database connection strings stored in Secrets Manager
stackfood/prod/postgresql/connection-string
stackfood/prod/cognito/client-secret
stackfood/prod/mercadopago/access-token
```

**Kubernetes Secrets (from AWS Secrets Manager):**

```yaml
# Using External Secrets Operator (optional)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: stackfood-db-secret
  namespace: orders
spec:
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: db-credentials
  data:
    - secretKey: connection-string
      remoteRef:
        key: stackfood/prod/postgresql/connection-string
```

---

## ğŸš€ Deployment & GitOps

### ArgoCD Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GIT REPOSITORY                             â”‚
â”‚         https://github.com/Stack-Food/stackfood-infra              â”‚
â”‚                                                                      â”‚
â”‚  apps/                                                              â”‚
â”‚  â”œâ”€â”€ customers/                                                     â”‚
â”‚  â”‚   â”œâ”€â”€ base/                                                      â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ deployment.yaml                                       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ service.yaml                                          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ ingress.yaml                                          â”‚
â”‚  â”‚   â”‚   â””â”€â”€ kustomization.yaml                                    â”‚
â”‚  â”‚   â””â”€â”€ prod/                                                      â”‚
â”‚  â”‚       â”œâ”€â”€ kustomization.yaml                                    â”‚
â”‚  â”‚       â””â”€â”€ namespace.yaml                                        â”‚
â”‚  â”œâ”€â”€ orders/...                                                     â”‚
â”‚  â”œâ”€â”€ products/...                                                   â”‚
â”‚  â”œâ”€â”€ payments/...                                                   â”‚
â”‚  â””â”€â”€ production/...                                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Git Pull (every 3 minutes)
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ARGOCD SERVER                              â”‚
â”‚                   Namespace: argocd                                 â”‚
â”‚                   URL: https://argo.stackfood.com.br               â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   ArgoCD Applications                         â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  - stackfood-customers-prod                                   â”‚  â”‚
â”‚  â”‚    Source: apps/customers/prod                                â”‚  â”‚
â”‚  â”‚    Destination: customers namespace                           â”‚  â”‚
â”‚  â”‚    Sync: Automated                                            â”‚  â”‚
â”‚  â”‚    Prune: Enabled                                             â”‚  â”‚
â”‚  â”‚    Self-Heal: Enabled                                         â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  - stackfood-orders-prod                                      â”‚  â”‚
â”‚  â”‚  - stackfood-products-prod                                    â”‚  â”‚
â”‚  â”‚  - stackfood-payments-prod                                    â”‚  â”‚
â”‚  â”‚  - stackfood-production-prod                                  â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚                           â”‚                                         â”‚
â”‚                           â”‚ kubectl apply                           â”‚
â”‚                           â–¼                                         â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   EKS CLUSTER                                 â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  Automatic deployment when:                                   â”‚  â”‚
â”‚  â”‚  1. Git repository changes                                    â”‚  â”‚
â”‚  â”‚  2. Cluster state drifts from desired state                   â”‚  â”‚
â”‚  â”‚  3. Manual sync triggered                                     â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  Rollback on failure:                                         â”‚  â”‚
â”‚  â”‚  - Automatic if health check fails                            â”‚  â”‚
â”‚  â”‚  - Manual rollback via ArgoCD UI                              â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CI/CD Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTINUOUS INTEGRATION                          â”‚
â”‚                                                                      â”‚
â”‚  Developer                                                          â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”‚ git push                                                      â”‚
â”‚     â–¼                                                                â”‚
â”‚  GitHub Repository                                                  â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”‚ trigger                                                       â”‚
â”‚     â–¼                                                                â”‚
â”‚  GitHub Actions                                                     â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”œâ”€ Build .NET 8 application                                    â”‚
â”‚     â”œâ”€ Run unit tests                                              â”‚
â”‚     â”œâ”€ Run integration tests                                       â”‚
â”‚     â”œâ”€ SonarCloud code analysis                                    â”‚
â”‚     â”œâ”€ Build Docker image                                          â”‚
â”‚     â”œâ”€ Tag: <service>:<git-sha>                                    â”‚
â”‚     â”œâ”€ Push to Amazon ECR                                          â”‚
â”‚     â”‚                                                                â”‚
â”‚     â””â”€ Update Kustomize image tag in stackfood-infra repo         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Git push to infra repo
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CONTINUOUS DEPLOYMENT (GitOps)                    â”‚
â”‚                                                                      â”‚
â”‚  stackfood-infra Repository                                        â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”‚ detected by ArgoCD (polling or webhook)                      â”‚
â”‚     â–¼                                                                â”‚
â”‚  ArgoCD                                                             â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”œâ”€ Compare desired state (Git) vs actual state (K8s)           â”‚
â”‚     â”œâ”€ Detect drift                                                â”‚
â”‚     â”œâ”€ Apply changes to cluster                                    â”‚
â”‚     â”œâ”€ Wait for pods to be ready                                   â”‚
â”‚     â”œâ”€ Run health checks                                           â”‚
â”‚     â”‚                                                                â”‚
â”‚     â”œâ”€ âœ… Success â†’ Application synced                             â”‚
â”‚     â””â”€ âŒ Failure â†’ Automatic rollback                             â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Deployment Strategy

**Rolling Update (default):**

```yaml
apiVersion: apps/v1
kind: Deployment
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Max 1 extra pod during update
      maxUnavailable: 0  # Never go below 2 pods
```

**Update Flow:**
1. Create new pod with new image
2. Wait for new pod to be Ready
3. Terminate one old pod
4. Repeat until all pods updated

---

## ğŸ“Š Monitoring & Observability

### Monitoring Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MONITORING ARCHITECTURE                        â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   METRICS COLLECTION                          â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚  Prometheus    â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ Node Exporter  â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚  Server        â”‚       â”‚ (each node)    â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚  â”‚  Namespace:    â”‚                                          â”‚  â”‚
â”‚  â”‚  â”‚  monitoring    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ kube-state-    â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚  Storage:      â”‚       â”‚ metrics        â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚  15d retention â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚                                          â”‚  â”‚
â”‚  â”‚  â”‚  Scrape:       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚  - /metrics    â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ Microservices  â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚  - /health     â”‚       â”‚ (Prometheus    â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚  Every 15s     â”‚       â”‚  middleware)   â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚                                          â”‚  â”‚
â”‚  â”‚  â”‚                â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ NGINX Ingress  â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚                â”‚       â”‚ /metrics       â”‚                 â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚           â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                                      â”‚
â”‚              â”‚ PromQL queries                                      â”‚
â”‚              â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   VISUALIZATION                               â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                   Grafana                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚            https://grafana.stackfood.com.br            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Dashboards:                                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Kubernetes Cluster Overview                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Microservices Performance                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - API Gateway Metrics                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - SNS/SQS Queue Metrics                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Database Performance                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - NGINX Ingress Metrics                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Alerts:                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - High error rate (5xx > 5%)                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Pod CPU > 80%                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Pod Memory > 90%                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Queue depth > 1000 messages                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - API latency p99 > 1s                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      AWS CLOUDWATCH                           â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  - API Gateway logs and metrics                              â”‚  â”‚
â”‚  â”‚  - Lambda execution logs                                     â”‚  â”‚
â”‚  â”‚  - EKS control plane logs                                    â”‚  â”‚
â”‚  â”‚  - RDS performance insights                                  â”‚  â”‚
â”‚  â”‚  - SNS/SQS metrics                                           â”‚  â”‚
â”‚  â”‚  - VPC Flow Logs                                             â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Metrics Tracked

**Application Metrics (exposed by microservices):**

```csharp
// ASP.NET Core metrics middleware
app.UseHttpMetrics();  // Prometheus middleware

// Custom business metrics
private static readonly Counter OrdersCreated = Metrics
    .CreateCounter("stackfood_orders_created_total", "Total orders created");

private static readonly Histogram OrderProcessingDuration = Metrics
    .CreateHistogram("stackfood_order_processing_duration_seconds",
        "Order processing duration");

private static readonly Gauge ActiveOrders = Metrics
    .CreateGauge("stackfood_orders_active", "Number of active orders");
```

**Exposed metrics:**
- `http_requests_total` - Total HTTP requests
- `http_request_duration_seconds` - Request latency histogram
- `http_requests_in_progress` - Current requests being processed
- `process_cpu_seconds_total` - CPU usage
- `dotnet_total_memory_bytes` - Memory usage
- `stackfood_orders_created_total` - Custom business metric

**Infrastructure Metrics:**
- Pod CPU/Memory usage
- Node CPU/Memory/Disk usage
- Network I/O
- Container restart count
- Deployment status

**AWS Metrics:**
- API Gateway: Count, Latency, 4XX/5XX errors
- SNS: Messages published, failed deliveries
- SQS: Messages sent/received, queue depth, age of oldest message
- RDS: Connections, CPU, storage, IOPS
- Lambda: Invocations, duration, errors, throttles
- NLB: Active connections, processed bytes, healthy targets

---

## âš¡ Scalability & Performance

### Horizontal Pod Autoscaler (HPA)

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: stackfood-orders-hpa
  namespace: orders
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: stackfood-orders
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 60
```

**Scaling Behavior:**
- **Scale Up**: Add 50% more pods every 60s (max)
- **Scale Down**: Remove 1 pod every 60s (max), wait 5min before scaling down
- **Example**: 2 pods â†’ 3 pods â†’ 4 pods â†’ 6 pods â†’ 9 pods â†’ 10 pods (max)

### Resource Limits

```yaml
resources:
  requests:
    cpu: 100m      # 0.1 CPU core guaranteed
    memory: 256Mi  # 256 MB guaranteed
  limits:
    cpu: 500m      # Max 0.5 CPU core
    memory: 512Mi  # Max 512 MB
```

**Quality of Service Classes:**
- **Guaranteed**: requests == limits â†’ Highest priority
- **Burstable**: requests < limits â†’ Medium priority (used by StackFood)
- **BestEffort**: No requests/limits â†’ Lowest priority

### Performance Targets

| Metric | Target | Measured | Status |
|--------|--------|----------|--------|
| API Latency (p50) | < 200ms | TBD | â³ |
| API Latency (p95) | < 500ms | TBD | â³ |
| API Latency (p99) | < 1s | TBD | â³ |
| Throughput | 1000 req/s | TBD | â³ |
| Error Rate | < 0.1% | TBD | â³ |
| Pod Startup Time | < 30s | ~15s | âœ… |
| HPA Scale-up Time | < 2min | ~90s | âœ… |
| Message Processing | < 1s | TBD | â³ |
| Database Query (p95) | < 100ms | TBD | â³ |

---

## ğŸ“ Diagrams for Tools

### PlantUML C4 Context Diagram

```plantuml
@startuml StackFood Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

title System Context Diagram for StackFood Platform

Person(customer, "Customer", "Mobile/Web user placing orders")
Person(staff, "Restaurant Staff", "Kitchen staff managing production")
Person(admin, "Administrator", "Back-office user managing system")

System(stackfood, "StackFood Platform", "Event-driven microservices platform for restaurant order management")

System_Ext(mercadopago, "Mercado Pago", "Payment gateway (fake checkout in MVP)")
System_Ext(cloudflare, "Cloudflare", "CDN, DNS, DDoS protection")
System_Ext(cognito, "AWS Cognito", "Identity provider and user management")

Rel(customer, stackfood, "Places orders, tracks status", "HTTPS")
Rel(staff, stackfood, "Views production queue", "HTTPS")
Rel(admin, stackfood, "Manages products, customers, orders", "HTTPS")

Rel(stackfood, mercadopago, "Processes payments", "HTTPS/REST")
Rel(cloudflare, stackfood, "Routes traffic", "HTTPS")
Rel(stackfood, cognito, "Authenticates users", "AWS SDK")

@enduml
```

### Mermaid Deployment Diagram

```mermaid
graph TB
    subgraph Internet
        Client[Client Browser/Mobile]
        CF[Cloudflare CDN]
    end

    subgraph AWS Cloud
        subgraph Edge
            APIGW[API Gateway<br/>pzfktuwsob]
            Lambda[Lambda Functions<br/>stackfood-auth]
        end

        subgraph VPC
            VPCLINK[VPC Link<br/>m0v6wp]
            NLB[Network Load Balancer]

            subgraph EKS Cluster
                NGINX[NGINX Ingress<br/>2 pods]

                subgraph Microservices
                    CUST[Customers<br/>:8084]
                    PROD[Products<br/>:8080]
                    ORD[Orders<br/>:8081]
                    PAY[Payments<br/>:8082]
                    PRODUCTION[Production<br/>:8083]
                end

                subgraph Supporting
                    ARGO[ArgoCD]
                    PROM[Prometheus]
                    GRAF[Grafana]
                end
            end

            subgraph Data
                RDS[(RDS PostgreSQL<br/>stackfood)]
                DDB[(DynamoDB<br/>payments)]
                SNS[SNS Topics]
                SQS[SQS Queues]
            end
        end

        COG[AWS Cognito<br/>User Pools]
    end

    Client -->|HTTPS| CF
    CF -->|HTTPS| APIGW
    APIGW -->|/auth, /customer| Lambda
    APIGW -->|/microservices/*| VPCLINK
    Lambda -->|Auth| COG
    Lambda -->|Create Customer| RDS
    VPCLINK --> NLB
    NLB --> NGINX
    NGINX --> CUST & PROD & ORD & PAY & PRODUCTION

    CUST & ORD & PRODUCTION --> RDS
    PAY --> DDB
    ORD & PAY & PRODUCTION --> SNS
    ORD & PAY & PRODUCTION --> SQS

    ARGO -.->|GitOps| CUST & PROD & ORD & PAY & PRODUCTION
    PROM -.->|Scrapes| CUST & PROD & ORD & PAY & PRODUCTION & NGINX
    GRAF -.->|Queries| PROM

    style APIGW fill:#FF9900
    style Lambda fill:#FF9900
    style EKS fill:#326CE5
    style RDS fill:#527FFF
    style DDB fill:#527FFF
```

### Mermaid Event Flow Sequence Diagram

```mermaid
sequenceDiagram
    participant C as Customer
    participant API as Orders API
    participant SNS as SNS: order-events
    participant SQS1 as SQS: payment-queue
    participant SQS2 as SQS: production-queue
    participant PAY as Payments API
    participant PROD as Production API
    participant PSNS as SNS: payment-events
    participant PRSNS as SNS: production-events
    participant OSQS1 as SQS: order-payment-queue
    participant OSQS2 as SQS: order-production-queue

    C->>API: POST /orders (create order)
    activate API
    API->>API: Save to PostgreSQL
    API->>SNS: Publish OrderCreated
    SNS-->>SQS1: Filter: OrderCreated
    SNS-->>SQS2: Filter: OrderCreated
    API-->>C: 201 Created
    deactivate API

    SQS1->>PAY: Poll message
    activate PAY
    PAY->>PAY: Process payment (fake checkout)
    PAY->>PSNS: Publish PaymentApproved
    PSNS-->>OSQS1: To orders queue
    deactivate PAY

    SQS2->>PROD: Poll message
    activate PROD
    PROD->>PROD: Add to production queue
    PROD->>PRSNS: Publish ProductionStarted
    PRSNS-->>OSQS2: To orders queue
    deactivate PROD

    OSQS1->>API: Poll PaymentApproved
    activate API
    API->>API: Update status: PaymentApproved
    deactivate API

    OSQS2->>API: Poll ProductionStarted
    activate API
    API->>API: Update status: InProduction
    deactivate API

    PROD->>PROD: Complete production
    activate PROD
    PROD->>PRSNS: Publish ProductionCompleted
    PRSNS-->>OSQS2: To orders queue
    deactivate PROD

    OSQS2->>API: Poll ProductionCompleted
    activate API
    API->>API: Update status: Ready
    API->>SNS: Publish OrderCompleted
    deactivate API
```

---

## ğŸ“ Technical Summary

### Technology Stack

| Layer | Technology | Version | Purpose |
|-------|-----------|---------|---------|
| **Language** | C# | 12 | Application code |
| **Framework** | ASP.NET Core | 8.0 | Web API framework |
| **ORM** | Entity Framework Core | 8.0 | Database access |
| **Container Runtime** | containerd | 1.7 | Container execution |
| **Orchestration** | Kubernetes | 1.34 | Container orchestration |
| **Managed K8s** | Amazon EKS | 1.34 | Kubernetes control plane |
| **Ingress** | NGINX Ingress Controller | 4.10.0 | L7 load balancing |
| **Load Balancer** | AWS NLB | - | L4 load balancing |
| **API Gateway** | AWS API Gateway | v1 (REST) | HTTP routing, rate limiting |
| **Serverless** | AWS Lambda | .NET 8 runtime | Auth functions |
| **Identity** | AWS Cognito | - | User authentication |
| **Relational DB** | PostgreSQL | 16.10 | Transactional data |
| **NoSQL DB** | DynamoDB | - | Payments, flexible schemas |
| **Messaging** | SNS + SQS | - | Event-driven communication |
| **GitOps** | ArgoCD | 4.5.2 | Continuous deployment |
| **Monitoring** | Prometheus + Grafana | - | Metrics and visualization |
| **IaC** | Terraform | 1.14.3 | Infrastructure as Code |
| **CDN** | Cloudflare | - | Edge caching, DDoS protection |

### Architecture Patterns

- âœ… **Microservices**: Independently deployable services
- âœ… **Event-Driven Architecture**: Asynchronous communication via SNS/SQS
- âœ… **Clean Architecture**: Domain-driven design, dependency inversion
- âœ… **Hexagonal Architecture**: Ports and adapters pattern
- âœ… **CQRS**: Command-query separation (implicit)
- âœ… **GitOps**: Infrastructure and apps as code in Git
- âœ… **Serverless**: Lambda for stateless auth operations
- âœ… **Hybrid Cloud**: Serverless + containers
- âœ… **Service Mesh Ready**: Prepared for Istio/Linkerd if needed

### Key Design Decisions

1. **PostgreSQL over DynamoDB for most services**: ACID guarantees, complex queries, joins
2. **DynamoDB for Payments**: High write throughput, flexible schema for external data
3. **SNS/SQS over direct HTTP**: Decoupling, retry logic, scalability
4. **NGINX Ingress over AWS ALB**: Kubernetes-native, advanced routing, free
5. **API Gateway over direct NLB**: Centralized routing, throttling, monitoring
6. **VPC Link over public NLB**: Security, private communication
7. **ArgoCD over manual kubectl**: Audit trail, rollback, declarative
8. **EKS over self-managed K8s**: Managed control plane, AWS integration
9. **Cognito over custom auth**: Managed service, JWT tokens, OIDC

---

## ğŸ“ Diagrams Ready for Documentation

### For C4 Model Documentation:
1. âœ… **System Context** - Shows external actors and systems
2. âœ… **Container Diagram** - Shows applications and data stores
3. âœ… **Component Diagram** - Shows internal structure (Customers example)
4. âœ… **Code Diagram** - Shows class structure (Entity examples)

### For PlantUML/Draw.io:
- Copy the PlantUML section above
- Paste into https://www.plantuml.com/plantuml/
- Export as PNG/SVG

### For Mermaid:
- Copy the Mermaid diagrams above
- Paste into https://mermaid.live/
- Or render directly in GitHub/GitLab markdown

### For Lucidchart/Excalidraw:
- Use the ASCII diagrams as reference
- Recreate with visual shapes and icons
- Add AWS/Kubernetes official icons

---

**Last Updated:** 2025-12-30
**Version:** 3.0.0 (Complete C4 Model + Infrastructure Details)
**Authors:** DevOps & Architecture Team
**Reviewed By:** Tech Lead

---

ğŸ—ï¸ **StackFood - Complete Architecture Documentation**
